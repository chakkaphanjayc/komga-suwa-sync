<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komga-Suwayomi Sync Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.0/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Komga-Suwayomi Sync Dashboard</h1>
            <div class="status-bar">
                <span id="sync-status" class="status">Status: <span class="status-text">Unknown</span></span>
                <span id="last-sync" class="status">Last Sync: <span class="status-text">Never</span></span>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="showTab('manga-lists')">Manga Lists</button>
            <button class="tab-btn" onclick="showTab('management')">Management</button>
            <button class="tab-btn" onclick="showTab('mappings')">Mappings</button>
            <button class="tab-btn" onclick="showTab('sync-log')">Sync Log</button>
        </nav>

        <main>
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Series Mappings</h3>
                        <div class="stat-number" id="series-count">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Chapter Mappings</h3>
                        <div class="stat-number" id="chapter-count">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Sync Cycles</h3>
                        <div class="stat-number" id="sync-cycles">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Errors</h3>
                        <div class="stat-number error" id="error-count">-</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3>Sync Controls</h3>
                    <div class="control-buttons">
                        <button id="test-connections-and-sync" class="btn btn-primary">Test Connections & Start Sync</button>
                        <button id="start-sync" class="btn btn-success">Start Sync</button>
                        <button id="stop-sync" class="btn btn-danger">Stop Sync</button>
                        <button id="run-match" class="btn btn-secondary">Run Initial Match</button>
                        <button id="test-connections" class="btn btn-info">Test Connections</button>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div id="activity-log" class="activity-list"></div>
                </div>

                <div class="matched-manga-section">
                    <h3>Matched Manga</h3>
                    <div class="matched-manga-controls">
                        <button id="refresh-matched" class="btn btn-primary">Refresh Matched Manga</button>
                        <span id="matched-count">0 matched series</span>
                    </div>
                    <div class="matched-manga-list" id="matched-manga-list">
                        <!-- Matched manga will be displayed here -->
                    </div>
                </div>
            </div>

            <div id="manga-lists" class="tab-content">
                <div class="manga-lists-grid">
                    <div class="manga-section">
                        <h3>Komga Series</h3>
                        <div class="manga-controls">
                            <button id="refresh-komga-manga" class="btn btn-primary">Refresh Komga Manga</button>
                            <input type="text" id="komga-search" placeholder="Search Komga series..." class="manga-search">
                            <span id="komga-count">0 series</span>
                        </div>
                        <div class="manga-list" id="komga-manga-list">
                            <!-- Komga manga will be displayed here -->
                        </div>
                    </div>

                    <div class="manga-section">
                        <h3>Suwayomi Manga</h3>
                        <div class="manga-controls">
                            <button id="refresh-suwayomi-manga" class="btn btn-primary">Refresh Suwayomi Manga</button>
                            <input type="text" id="suwayomi-search" placeholder="Search Suwayomi manga..." class="manga-search">
                            <span id="suwayomi-count">0 manga</span>
                        </div>
                        <div class="manga-list" id="suwayomi-manga-list">
                            <!-- Suwayomi manga will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="management" class="tab-content">
                <div class="management-grid">
                    <!-- Configuration Section -->
                    <div class="management-panel">
                        <h3>Configuration</h3>
                        <div class="config-section">
                            <h4>Komga Configuration</h4>
                            <form id="komga-config">
                                <div class="form-group">
                                    <label for="komga-base">Base URL:</label>
                                    <input type="text" id="komga-base" name="komga-base">
                                </div>
                                <div class="form-group">
                                    <label for="komga-user">Username:</label>
                                    <input type="text" id="komga-user" name="komga-user">
                                </div>
                                <div class="form-group">
                                    <label for="komga-pass">Password:</label>
                                    <input type="password" id="komga-pass" name="komga-pass">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Komga Config</button>
                            </form>
                        </div>

                        <div class="config-section">
                            <h4>Suwayomi Configuration</h4>
                            <form id="suwa-config">
                                <div class="form-group">
                                    <label for="suwa-base">Base URL:</label>
                                    <input type="text" id="suwa-base" name="suwa-base">
                                </div>
                                <div class="auth-method-selector">
                                    <h5>Authentication Method:</h5>
                                    <div class="auth-tabs">
                                        <button type="button" class="auth-tab active" onclick="switchAuthMethod('token')">Bearer Token</button>
                                        <button type="button" class="auth-tab" onclick="switchAuthMethod('basic')">Basic Auth</button>
                                    </div>
                                </div>
                                <div id="token-auth" class="auth-fields">
                                    <div class="form-group">
                                        <label for="suwa-token">Token (optional):</label>
                                        <input type="text" id="suwa-token" name="suwa-token">
                                    </div>
                                </div>
                                <div id="basic-auth" class="auth-fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="suwa-user">Username:</label>
                                        <input type="text" id="suwa-user" name="suwa-user">
                                    </div>
                                    <div class="form-group">
                                        <label for="suwa-pass">Password:</label>
                                        <input type="password" id="suwa-pass" name="suwa-pass">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Suwayomi Config</button>
                            </form>
                        </div>

                        <div class="config-section">
                            <h4>Sync Configuration</h4>
                            <form id="sync-config">
                                <div class="form-group">
                                    <label for="sync-interval">Sync Interval (ms):</label>
                                    <input type="number" id="sync-interval" name="sync-interval">
                                </div>
                                <div class="form-group">
                                    <label for="fuzzy-threshold">Fuzzy Threshold:</label>
                                    <input type="number" id="fuzzy-threshold" name="fuzzy-threshold" step="0.01" min="0" max="1">
                                </div>
                                <div class="form-group">
                                    <label for="log-level">Log Level:</label>
                                    <select id="log-level" name="log-level">
                                        <option value="error">Error</option>
                                        <option value="warn">Warn</option>
                                        <option value="info">Info</option>
                                        <option value="debug">Debug</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="dry-run">Dry Run Mode:</label>
                                    <input type="checkbox" id="dry-run" name="dry-run">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Sync Config</button>
                            </form>
                        </div>
                    </div>

                    <!-- Logs Section -->
                    <div class="management-panel">
                        <h3>Logs</h3>
                        <div class="logs-controls">
                            <button id="clear-logs" class="btn btn-secondary">Clear Logs</button>
                            <button id="download-logs" class="btn btn-secondary">Download Logs</button>
                            <select id="log-filter">
                                <option value="all">All Levels</option>
                                <option value="error">Errors Only</option>
                                <option value="warn">Warnings+</option>
                                <option value="info">Info+</option>
                                <option value="debug">Debug+</option>
                            </select>
                        </div>
                        <div id="logs-container" class="logs-container"></div>
                    </div>

                    <!-- API Debug Section -->
                    <div class="management-panel">
                        <h3>API Debug</h3>
                        <div class="api-section">
                            <h4>Komga API Status</h4>
                            <div class="api-status" id="komga-status">
                                <div class="status-indicator">
                                    <span class="status-dot" id="komga-dot"></span>
                                    <span class="status-text" id="komga-status-text">Checking...</span>
                                </div>
                                <button id="test-komga" class="btn btn-small">Test Connection</button>
                            </div>
                            <div class="api-details" id="komga-details"></div>
                        </div>

                        <div class="api-section">
                            <h4>Suwayomi API Status</h4>
                            <div class="api-status" id="suwa-status">
                                <div class="status-indicator">
                                    <span class="status-dot" id="suwa-dot"></span>
                                    <span class="status-text" id="suwa-status-text">Checking...</span>
                                </div>
                                <button id="test-suwa" class="btn btn-small">Test Connection</button>
                            </div>
                            <div class="api-details" id="suwa-details"></div>
                        </div>

                        <div class="api-section">
                            <h4>Quick API Tests</h4>
                            <div class="quick-tests">
                                <button id="test-komga-series" class="btn btn-small">Test Komga Series</button>
                                <button id="test-suwa-library" class="btn btn-small">Test Suwayomi Library</button>
                                <button id="test-mapping-count" class="btn btn-small">Test Mapping Count</button>
                                <button id="get-schema-info" class="btn btn-small">Get GraphQL Schema</button>
                            </div>
                            <div class="api-response" id="api-response"></div>
                        </div>
                    </div>
                </div>
            </div>





            <div id="mappings" class="tab-content">
                <div class="mappings-controls">
                    <button id="refresh-mappings" class="btn btn-primary">Refresh Mappings</button>
                    <input type="text" id="mapping-search" placeholder="Search mappings...">
                </div>

                <div class="mappings-tables">
                    <div class="mapping-section">
                        <h3>Series Mappings</h3>
                        <div class="table-container">
                            <table id="series-table">
                                <thead>
                                    <tr>
                                        <th>Komga Series</th>
                                        <th>Suwayomi Manga</th>
                                        <th>Normalized Title</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="series-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mapping-section">
                        <h3>Chapter Mappings</h3>
                        <div class="table-container">
                            <table id="chapter-table">
                                <thead>
                                    <tr>
                                        <th>Komga Book</th>
                                        <th>Suwayomi Chapter</th>
                                        <th>Chapter #</th>
                                        <th>Last Sync</th>
                                    </tr>
                                </thead>
                                <tbody id="chapter-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sync-log" class="tab-content">
                <div class="sync-log-controls">
                    <button id="refresh-sync-log" class="btn btn-primary">Refresh Sync Log</button>
                    <button id="trigger-manual-sync" class="btn btn-success">Trigger Manual Sync</button>
                    <button id="sync-komga-to-suwa" class="btn btn-info">Sync Komga → Suwayomi</button>
                    <button id="sync-suwa-to-komga" class="btn btn-info">Sync Suwayomi → Komga</button>
                    <button id="clear-sync-log" class="btn btn-danger">Clear Sync Log</button>
                    <span id="sync-log-status">Loading...</span>
                </div>

                <div class="sync-stats-grid">
                    <div class="sync-stat-card">
                        <h4>Total Mappings</h4>
                        <div class="sync-stat-number" id="total-mappings">-</div>
                    </div>
                    <div class="sync-stat-card">
                        <h4>Synced Komga → Suwayomi</h4>
                        <div class="sync-stat-number" id="synced-komga-to-suwa">-</div>
                    </div>
                    <div class="sync-stat-card">
                        <h4>Synced Suwayomi → Komga</h4>
                        <div class="sync-stat-number" id="synced-suwa-to-komga">-</div>
                    </div>
                    <div class="sync-stat-card">
                        <h4>Never Synced</h4>
                        <div class="sync-stat-number" id="never-synced">-</div>
                    </div>
                </div>

                <div class="recent-sync-activities">
                    <h3>Recent Sync Activities</h3>
                    <div class="sync-activities-columns">
                        <div class="sync-column">
                            <h4>Komga Activities</h4>
                            <div id="komga-sync-entries" class="sync-activities-list">
                                <!-- Komga sync activities will be displayed here -->
                            </div>
                        </div>
                        <div class="sync-column">
                            <h4>Suwayomi Activities</h4>
                            <div id="suwayomi-sync-entries" class="sync-activities-list">
                                <!-- Suwayomi sync activities will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
</body>
</html>
